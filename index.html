<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ - Ù„ÙˆØ§Ø¡ 306</title>
    <style>
        :root { --main-color: #1b5e20; --edit-color: #f57c00; --excel-color: #2e7d32; --archive-color: #c62828; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f4f4f9; margin: 0; padding: 0; transition: 0.3s; background-attachment: fixed; background-size: cover; background-position: center; }
        
        /* Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ */
        #loginPage { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, var(--main-color) 0%, #000 100%); position: fixed; width: 100%; top: 0; left: 0; z-index: 9999; }
        .login-card { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 350px; text-align: center; }
        .login-card input { margin-bottom: 12px; padding: 12px; width: 100%; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
        #mainContent { display: none; padding: 20px; }
        .admin-only { display: none; } /* Ø³ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø±Ù‡Ø§ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· */

        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 4px solid var(--main-color); }
        .stat-card h4 { margin: 0; color: #666; font-size: 14px; }
        .stat-card p { margin: 5px 0 0; font-size: 24px; font-weight: bold; color: var(--main-color); }

        .container { max-width: 1200px; margin: auto; background: rgba(255, 255, 255, 0.96); padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .main-header { text-align: center; border-bottom: 4px double var(--main-color); margin-bottom: 30px; padding-bottom: 10px; position: relative; }
        .logout-btn { position: absolute; left: 0; top: 0; background: #c62828; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; border-radius: 8px; overflow: hidden; }
        th { background: var(--main-color); color: white; padding: 12px; }
        td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .penalty-row { background-color: #ffebee; }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; }
        .modal-content { background: white; margin: 5% auto; padding: 30px; width: 80%; border-radius: 15px; max-height: 80vh; overflow-y: auto; }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .btn-save { background: var(--main-color); color: white; padding: 15px 50px; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; display: block; margin: 20px auto; }
        
        .action-bar { display: flex; gap: 10px; margin: 20px 0; background: #eee; padding: 15px; border-radius: 10px; align-items: center; }
        .search-box { flex: 2; padding: 12px; border: 2px solid var(--main-color); border-radius: 8px; font-size: 16px; }
    </style>
</head>
<body>

<div id="loginPage">
    <div class="login-card">
        <h2 id="loginTitle" style="color: var(--main-color);">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ</h2>
        <input type="text" id="userInp" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="passInp" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button onclick="handleLogin()" class="btn-save" style="width: 100%; margin: 0;">Ø¯Ø®ÙˆÙ„</button>
        <p style="font-size: 12px; color: #888; margin-top: 10px;">Ù…Ø¯ÙŠØ±: admin | Ù…Ø³ØªØ®Ø¯Ù…: user</p>
    </div>
</div>

<div id="mainContent">
    <div class="container">
        <div class="main-header">
            <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
            <h1 id="welcomeMsg">Ø§Ù„Ø¹Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ - Ù„ÙˆØ§Ø¡ 306</h1>
            <p>Ø°ÙŠ Ù‚Ø§Ø± - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø£Ø±Ø´ÙØ©</p>
        </div>

        <div class="admin-only">
            <div class="stats-grid" id="statsArea">
                </div>
        </div>

        <div class="admin-only">
            <form id="dataForm">
                <input type="hidden" id="editIndex" value="-1">
                <div class="grid-container">
                    <input type="text" id="idNo" placeholder="ID" required>
                    <input type="text" id="fullName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
                    <select id="battalion">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙÙˆØ¬</option>
                        <option>Ø§Ù„ÙÙˆØ¬ Ø§Ù„Ø£ÙˆÙ„</option><option>Ø§Ù„ÙÙˆØ¬ Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option>Ø§Ù„ÙÙˆØ¬ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                    </select>
                    <select id="companyNo" required><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø±ÙŠØ©</option></select>
                    <input type="text" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                    <input type="text" id="category" placeholder="Ø§Ù„ØµÙ†Ù">
                    <textarea id="notes" style="grid-column: 1/-1" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></textarea>
                </div>
                <button type="submit" id="submitBtn" class="btn-save">Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</button>
            </form>
        </div>

        <div class="action-bar">
            <input type="text" id="searchInput" class="search-box" onkeyup="searchData()" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ID Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©...">
            <div class="admin-only" style="display:flex; gap:5px;">
                <button onclick="exportToExcel()" style="background:var(--excel-color); color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">ØªØµØ¯ÙŠØ±</button>
                <button onclick="document.getElementById('importFile').click()" style="background:#0277bd; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
                <input type="file" id="importFile" hidden accept=".csv" onchange="importCSV(this)">
            </div>
        </div>

        <h3 id="tableTitle">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3>
        <div style="overflow-x:auto">
            <table>
                <thead>
                    <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>ID</th><th>Ø§Ù„ÙÙˆØ¬</th><th>Ø§Ù„Ø³Ø±ÙŠØ©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="admin-only" style="margin-top: 50px;">
            <h3 style="color: var(--archive-color);">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª ÙˆØ§Ù„Ø£Ø±Ø´ÙŠÙ</h3>
            <div style="overflow-x:auto">
                <table>
                    <thead style="background: var(--archive-color);">
                        <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>ID</th><th>Ø§Ù„ÙÙˆØ¬</th><th>Ø³Ø¨Ø¨ Ø§Ù„Ø£Ø±Ø´ÙØ©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
                    </thead>
                    <tbody id="archiveBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="viewModal" class="modal">
    <div class="modal-content">
        <div id="viewArea"></div>
        <hr>
        <button onclick="document.getElementById('viewModal').style.display='none'" style="padding:10px; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
    let currentUser = null;
    const labels = { idNo: "ID", fullName: "Ø§Ù„Ø§Ø³Ù…", battalion: "Ø§Ù„ÙÙˆØ¬", companyNo: "Ø§Ù„Ø³Ø±ÙŠØ©", phone: "Ø§Ù„Ù‡Ø§ØªÙ", category: "Ø§Ù„ØµÙ†Ù", notes: "Ù…Ù„Ø§Ø­Ø¸Ø§Øª" };

    // 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªØ·ÙˆØ±
    function handleLogin() {
        const u = document.getElementById('userInp').value;
        const p = document.getElementById('passInp').value;
        
        if (u === 'admin' && p === '1234') {
            currentUser = 'admin';
            localStorage.setItem('role', 'admin');
            initApp();
        } else if (u === 'user' && p === '1234') {
            currentUser = 'user';
            localStorage.setItem('role', 'user');
            initApp();
        } else {
            alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©!");
        }
    }

    function initApp() {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        if (currentUser === 'admin') {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
            document.getElementById('welcomeMsg').innerText = "Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± - Ù„ÙˆØ§Ø¡ 306";
        } else {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
            document.getElementById('welcomeMsg').innerText = "Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©";
            document.getElementById('tableTitle').innerText = "Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø®ØµØµØ©";
        }
        updateStats();
        renderTable();
    }

    // 2. Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    function updateStats() {
        if (currentUser !== 'admin') return;
        const data = JSON.parse(localStorage.getItem('army_db_306') || '[]');
        const stats = {
            total: data.length,
            f1: data.filter(i => i.battalion === 'Ø§Ù„ÙÙˆØ¬ Ø§Ù„Ø£ÙˆÙ„').length,
            f2: data.filter(i => i.battalion === 'Ø§Ù„ÙÙˆØ¬ Ø§Ù„Ø«Ø§Ù†ÙŠ').length,
            f3: data.filter(i => i.battalion === 'Ø§Ù„ÙÙˆØ¬ Ø§Ù„Ø«Ø§Ù„Ø«').length,
            archive: JSON.parse(localStorage.getItem('army_archive_306') || '[]').length
        };

        document.getElementById('statsArea').innerHTML = `
            <div class="stat-card"><h4>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</h4><p>${stats.total}</p></div>
            <div class="stat-card"><h4>Ø§Ù„ÙÙˆØ¬ 1</h4><p>${stats.f1}</p></div>
            <div class="stat-card"><h4>Ø§Ù„ÙÙˆØ¬ 2</h4><p>${stats.f2}</p></div>
            <div class="stat-card"><h4>Ø§Ù„ÙÙˆØ¬ 3</h4><p>${stats.f3}</p></div>
            <div class="stat-card" style="border-color:red"><h4>Ø¹Ù‚ÙˆØ¨Ø§Øª</h4><p>${stats.archive}</p></div>
        `;
    }

    // 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    function renderTable(filterData = null) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ: Ù„Ø§ ØªØ¸Ù‡Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨Ø­Ø«
        let data = filterData;
        if (currentUser === 'user' && !filterData) {
            tbody.innerHTML = '<tr><td colspan="5">ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ù„Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡...</td></tr>';
            return;
        }
        
        if (!data) data = JSON.parse(localStorage.getItem('army_db_306') || '[]');

        data.forEach((item, index) => {
            let row = `<tr>
                <td>${item.fullName}</td><td>${item.idNo}</td><td>${item.battalion}</td><td>${item.companyNo}</td>
                <td>
                    <button onclick="previewRecord(${index}, false)" style="background:#0288d1; color:white; border:none; padding:5px; cursor:pointer;">ğŸ‘</button>
                    <button onclick="printRecord(${index}, false)" style="background:#444; color:white; border:none; padding:5px; cursor:pointer;">ğŸ–¨</button>
                    ${currentUser === 'admin' ? `
                        <button onclick="editRecord(${index})" style="background:#f57c00; color:white; border:none; padding:5px; cursor:pointer;">âœï¸</button>
                        <button onclick="archiveRecord(${index})" title="Ù†Ù‚Ù„ Ù„Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª" style="background:red; color:white; border:none; padding:5px; cursor:pointer;">âš–ï¸</button>
                    ` : ''}
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });

        if (currentUser === 'admin') renderArchive();
    }

    function renderArchive() {
        const abody = document.getElementById('archiveBody');
        abody.innerHTML = '';
        const archive = JSON.parse(localStorage.getItem('army_archive_306') || '[]');
        archive.forEach((item, index) => {
            abody.innerHTML += `<tr class="penalty-row">
                <td>${item.fullName}</td><td>${item.idNo}</td><td>${item.battalion}</td><td>${item.archiveReason || 'Ø¹Ù‚ÙˆØ¨Ø©'}</td>
                <td>
                    <button onclick="previewRecord(${index}, true)" style="background:#0288d1; color:white; border:none; padding:5px; cursor:pointer;">ğŸ‘</button>
                    <button onclick="restoreRecord(${index})" style="background:green; color:white; border:none; padding:5px; cursor:pointer;">â™»ï¸</button>
                </td>
            </tr>`;
        });
    }

    // 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø±Ø´ÙØ© ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª
    function archiveRecord(index) {
        let reason = prompt("Ø§Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø© Ø£Ùˆ Ø§Ù„Ø£Ø±Ø´ÙØ©:");
        if (!reason) return;
        
        let data = JSON.parse(localStorage.getItem('army_db_306'));
        let archive = JSON.parse(localStorage.getItem('army_archive_306') || '[]');
        
        let item = data.splice(index, 1)[0];
        item.archiveReason = reason;
        archive.push(item);
        
        localStorage.setItem('army_db_306', JSON.stringify(data));
        localStorage.setItem('army_archive_306', JSON.stringify(archive));
        updateStats();
        renderTable();
    }

    function restoreRecord(index) {
        let archive = JSON.parse(localStorage.getItem('army_archive_306'));
        let data = JSON.parse(localStorage.getItem('army_db_306'));
        data.push(archive.splice(index, 1)[0]);
        localStorage.setItem('army_db_306', JSON.stringify(data));
        localStorage.setItem('army_archive_306', JSON.stringify(archive));
        updateStats();
        renderTable();
    }

    // 5. Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø®ØµØµ
    function searchData() {
        const v = document.getElementById('searchInput').value.toLowerCase();
        const data = JSON.parse(localStorage.getItem('army_db_306') || '[]');
        
        if (v.trim() === "") {
            renderTable(currentUser === 'admin' ? data : null);
            return;
        }

        const filtered = data.filter(i => i.fullName.toLowerCase().includes(v) || i.idNo.includes(v));
        renderTable(filtered);
    }

    // 6. ØªÙ‡ÙŠØ¦Ø© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
    document.getElementById('dataForm').onsubmit = function(e) {
        e.preventDefault();
        let record = {};
        this.querySelectorAll('input, select, textarea').forEach(f => { if(f.id !== 'editIndex') record[f.id] = f.value; });
        let data = JSON.parse(localStorage.getItem('army_db_306') || '[]');
        let idx = document.getElementById('editIndex').value;
        if(idx === "-1") data.push(record); else data[idx] = record;
        localStorage.setItem('army_db_306', JSON.stringify(data));
        this.reset();
        document.getElementById('editIndex').value = "-1";
        updateStats();
        renderTable();
    };

    function previewRecord(index, isArchive) {
        const source = isArchive ? 'army_archive_306' : 'army_db_306';
        const item = JSON.parse(localStorage.getItem(source))[index];
        let h = `<h2>Ù…Ø¹Ø§ÙŠÙ†Ø©: ${item.fullName}</h2><div class="grid-container">`;
        for(let k in labels) h += `<p><b>${labels[k]}:</b> ${item[k] || '---'}</p>`;
        if(isArchive) h += `<p style="color:red"><b>Ø§Ù„Ø³Ø¨Ø¨:</b> ${item.archiveReason}</p>`;
        document.getElementById('viewArea').innerHTML = h + `</div>`;
        document.getElementById('viewModal').style.display = 'block';
    }

    function printRecord(index, isArchive) {
        const source = isArchive ? 'army_archive_306' : 'army_db_306';
        const item = JSON.parse(localStorage.getItem(source))[index];
        const win = window.open('', '_blank');
        win.document.write(`<html><head><style>body{direction:rtl; font-family:tahoma; padding:40px; border:10px double #1b5e20; min-height:90vh;}</style></head><body><h1 style="text-align:center">Ù„ÙˆØ§Ø¡ 306 - Ø§Ø³ØªÙ…Ø§Ø±Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h1><hr>`);
        for(let k in labels) win.document.write(`<p style="font-size:20px;"><b>${labels[k]}:</b> ${item[k] || '---'}</p>`);
        win.document.write(`</body></html>`);
        win.document.close();
        setTimeout(() => win.print(), 500);
    }

    function logout() { localStorage.clear(); location.reload(); }

    const compSel = document.getElementById('companyNo');
    for(let i=1; i<=40; i++) {
        let opt = document.createElement('option'); opt.value = "Ø§Ù„Ø³Ø±ÙŠØ© " + i; opt.text = "Ø§Ù„Ø³Ø±ÙŠØ© " + i;
        compSel.appendChild(opt);
    }

    window.onload = () => { if(localStorage.getItem('role')) { currentUser = localStorage.getItem('role'); initApp(); } };
</script>
</body>
</html>
