<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ - Ù„ÙˆØ§Ø¡ 306</title>
<style>
body{font-family:'Segoe UI',Tahoma,sans-serif;margin:0;padding:0;background:#f4f4f9;direction:rtl;background-size:cover;background-attachment:fixed;}
.container{max-width:1400px;margin:20px auto;background:rgba(255,255,255,0.95);padding:25px;border-radius:15px;box-shadow:0 5px 25px rgba(0,0,0,0.1);}
h2{text-align:center;color:#1b5e20;margin:0 0 20px 0;}
.tabs{display:flex;gap:10px;margin-bottom:20px;}
.tab-btn{padding:10px 15px;border:none;border-radius:5px;background:#333;color:white;cursor:pointer;font-weight:bold;transition:.3s;}
.tab-btn.active{background:#1b5e20;}
.tab-content{display:none;}
.tab-content.active{display:block;}
.form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.form-grid div{display:flex;flex-direction:column;}
label{font-size:13px;font-weight:bold;margin-bottom:4px;color:#333;}
input,select{padding:10px;border:1px solid #ccc;border-radius:5px;text-align:center;font-size:14px;}
.btn{border:none;padding:8px 12px;border-radius:5px;cursor:pointer;color:white;font-weight:bold;margin:0 5px 10px 0;}
.btn-main{background:#1b5e20;}
.btn-export{background:#2e7d32;}
.btn-import{background:#1565c0;}
.btn-pen{background:#c62828;}
.btn-undo{background:#6a1b9a;}
.dropdown{position:absolute;background:white;border:1px solid #ddd;max-height:200px;overflow-y:auto;display:none;width:100%;z-index:1000;}
.dropdown div{padding:10px;cursor:pointer;border-bottom:1px solid #eee;}
.dropdown div:hover{background:#f0f0f0;}
.table-wrapper{width:100%;overflow-x:auto;margin-top:15px;border:1px solid #ddd;}
.db-table{width:100%;border-collapse:collapse;min-width:1200px;}
.db-table th{background:#0277bd;color:white;padding:10px;border:1px solid #ddd;position:sticky;top:0;}
.db-table td{padding:6px;border:1px solid #ddd;text-align:center;font-size:13px;}
.duplicate{color:red;font-weight:bold;}
.stats{margin-bottom:10px;padding:10px;background:#eee;border-radius:8px;font-weight:bold;}
</style>
</head>
<body>
<div class="container">
<h2>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ - Ù„ÙˆØ§Ø¡ 306</h2>

<div class="tabs">
<button class="tab-btn active" onclick="showTab('tabForm',this)">ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
<button class="tab-btn" onclick="showTab('tabDB',this)">ğŸ“‹ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</button>
<button class="tab-btn" onclick="showTab('tabPen',this)">âš–ï¸ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª</button>
</div>

<!-- ØªØ¨ÙˆÙŠØ¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
<div id="tabForm" class="tab-content active">
<div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
    <button class="btn btn-main" onclick="document.getElementById('settingsModal').style.display='block'">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    <input type="text" id="mainSearch" placeholder="ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ Ø¨Ø§Ù„Ø§Ø³Ù…..." onkeyup="liveSearch(this.value)" style="flex:1; padding:8px; border-radius:5px; border:1px solid #ccc; text-align:center;">
    <button class="btn btn-main" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <button class="btn btn-export" onclick="exportCSV('DB')">ØªØµØ¯ÙŠØ± CSV</button>
    <input type="file" id="importFile" style="display:none" accept=".csv" onchange="importCSV(this,'DB')">
    <button class="btn btn-import" onclick="document.getElementById('importFile').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV</button>
</div>

<form id="mainForm" onsubmit="saveData(event); return false;">
<div class="form-grid">
  <!-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ 31 ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
  <div><label>ID</label><input type="text" id="idNo"></div>
  <div><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ ÙˆØ§Ù„Ù„Ù‚Ø¨</label><input type="text" id="fullName" required></div>
  <div><label>Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯</label><input type="text" id="birthDate"></div>
  <div><label>Ù…Ø­Ù„ Ø§Ù„ØªÙˆÙ„Ø¯</label><input type="text" id="birthPlace"></div>
  <div><label>Ø§Ù„Ø¬Ù†Ø³</label><input type="text" id="gender"></div>
  <div><label>Ø§Ø³Ù… Ø§Ù„Ø£Ù…</label><input type="text" id="motherName"></div>
  <div><label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label><input type="text" id="natId"></div>
  <div><label>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</label><input type="text" id="marital"></div>
  <div><label>Ø§Ø³Ù… Ø§Ù„Ø²ÙˆØ¬Ø©</label><input type="text" id="spouse"></div>
  <div><label>Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø·ÙØ§Ù„</label><input type="text" id="kids"></div>
  <div><label>Ø§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label><input type="text" id="edu"></div>
  <div><label>Ø§Ù„ØªØ®ØµØµ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label><input type="text" id="spec"></div>
  <div><label>Ø§Ù„Ø¹Ù…Ù„</label><input type="text" id="job"></div>
  <div><label>Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label><input type="text" id="prov"></div>
  <div><label>Ø§Ù„Ù‚Ø¶Ø§Ø¡</label><input type="text" id="dist"></div>
  <div><label>Ø§Ù„Ù†Ø§Ø­ÙŠØ©</label><input type="text" id="subDist"></div>
  <div><label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label><input type="text" id="region"></div>
  <div><label>Ø§Ù„Ù…Ø­Ù„Ø©</label><input type="text" id="mahala"></div>
  <div><label>Ø§Ù„Ø²Ù‚Ø§Ù‚</label><input type="text" id="zuqaq"></div>
  <div><label>Ø§Ù„Ø¯Ø§Ø±</label><input type="text" id="dar"></div>
  <div><label>Ø£Ù‚Ø±Ø¨ Ù†Ù‚Ø·Ø© Ø¯Ø§Ù„Ø©</label><input type="text" id="point"></div>
  <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="phone"></div>
  <div><label>Ø§Ù„Ù„ÙˆØ§Ø¡</label><input type="text" id="brigade"></div>
  <div><label>Ø§Ù„ÙÙˆØ¬</label><input type="text" id="fowj"></div>
  <div><label>Ø§Ù„Ø³Ø±ÙŠØ© (Ø±Ù‚Ù…)</label><input type="text" id="sariyaNum"></div>
  <div><label>Ø§Ù„ØµÙ†Ù</label><input type="text" id="sanaf"></div>
  <div><label>Ø§Ù„Ø®Ø¨Ø±Ø§Øª Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠØ©</label><input type="text" id="exp"></div>
  <div><label>Ø§Ù„Ù…Ø¹Ø±Ù</label><input type="text" id="refN"></div>
  <div><label>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø¹Ø±Ù</label><input type="text" id="refP"></div>
  <div style="grid-column: span 2;"><label>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input type="text" id="notes"></div>
  <div style="grid-column: span 2;"><label>Ø§Ø³Ù… Ø§Ù„Ø³Ø±ÙŠØ©</label><input type="text" id="sariyaName"></div>
</div>
<button type="submit" class="btn btn-main">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
</form>
<div id="searchDropdown" class="dropdown"></div>
</div>

<!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
<div id="tabDB" class="tab-content">
<div class="stats" id="statsDB">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
<input type="text" id="searchDB" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹" onkeyup="renderTable('DB')">
<select id="filterFowjDB" onchange="renderTable('DB')"><option value="">ÙƒÙ„ Ø§Ù„Ø£ÙÙˆØ§Ø¬</option></select>
<select id="filterSNumDB" onchange="renderTable('DB')"><option value="">ÙƒÙ„ Ø§Ù„Ø³Ø±Ø§ÙŠØ§</option></select>
<select id="filterSNameDB" onchange="renderTable('DB')"><option value="">ÙƒÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø³Ø±Ø§ÙŠØ§</option></select>
<button onclick="exportCSV('DB')" class="btn btn-export">ØªØµØ¯ÙŠØ± CSV</button>
<input type="file" id="importFileDB" style="display:none" accept=".csv" onchange="importCSV(this,'DB')">
<button onclick="document.getElementById('importFileDB').click()" class="btn btn-import">Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV</button>
<div class="table-wrapper">
<table class="db-table" id="tableDB"><thead></thead><tbody></tbody></table>
</div>
</div>

<!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª -->
<div id="tabPen" class="tab-content">
<div class="stats" id="statsPEN">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
<input type="text" id="searchPen" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹" onkeyup="renderTable('PEN')">
<select id="filterFowjPen" onchange="renderTable('PEN')"><option value="">ÙƒÙ„ Ø§Ù„Ø£ÙÙˆØ§Ø¬</option></select>
<select id="filterSNumPen" onchange="renderTable('PEN')"><option value="">ÙƒÙ„ Ø§Ù„Ø³Ø±Ø§ÙŠØ§</option></select>
<select id="filterSNamePen" onchange="renderTable('PEN')"><option value="">ÙƒÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø³Ø±Ø§ÙŠØ§</option></select>
<button onclick="exportCSV('PEN')" class="btn btn-export">ØªØµØ¯ÙŠØ± CSV</button>
<input type="file" id="importFilePen" style="display:none" accept=".csv" onchange="importCSV(this,'PEN')">
<button onclick="document.getElementById('importFilePen').click()" class="btn btn-import">Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV</button>
<div class="table-wrapper">
<table class="db-table" id="tablePEN"><thead></thead><tbody></tbody></table>
</div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
<div id="settingsModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2000;">
  <div style="background:white;width:400px;margin:5% auto;padding:20px;border-radius:10px;position:relative;">
    <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</h3>
    <label>Ù„ÙˆÙ† Ø§Ù„Ù†Ø¸Ø§Ù…:</label>
    <input type="color" id="themeColorPicker" value="#1b5e20" style="width:100%; height:35px; margin-bottom:10px;" onchange="changeTheme(this.value)">
    <label>Ø®Ù„ÙÙŠØ© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©:</label>
    <input type="file" id="bgInput" style="width:100%; margin-bottom:10px;" onchange="updateBackground(this)">
    <button class="btn btn-main" onclick="document.getElementById('settingsModal').style.display='none'" style="width:100%;">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<script>
const DB_KEY='db_306_data';
const PEN_KEY='db_306_pen';
const fields=["idNo","fullName","birthDate","birthPlace","gender","motherName","natId","marital","spouse","kids","edu","spec","job","prov","dist","subDist","region","mahala","zuqaq","dar","point","phone","brigade","fowj","sariyaNum","sanaf","exp","refN","refP","notes","sariyaName"];

function showTab(id,btn){
  document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

function saveData(e){
  e.preventDefault();
  let db=JSON.parse(localStorage.getItem(DB_KEY)||'[]');
  let data={}; fields.forEach(f=>data[f]=document.getElementById(f).value);
  db.push(data);
  localStorage.setItem(DB_KEY,JSON.stringify(db));
  e.target.reset();
  alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­");
  renderTable('DB');
}

function liveSearch(val){
  const db=JSON.parse(localStorage.getItem(DB_KEY)||'[]');
  const drop=document.getElementById('searchDropdown');
  if(!val){ drop.style.display='none'; return; }
  let matches=db.filter(x=>x.fullName.includes(val));
  drop.innerHTML = matches.map((m,i)=>`<div onclick="fillForm(${i})">${m.fullName}</div>`).join('');
  drop.style.display = matches.length?'block':'none';
}

function fillForm(i){
  const db=JSON.parse(localStorage.getItem(DB_KEY)||'[]');
  fields.forEach(f=>document.getElementById(f).value=db[i][f]||'');
  document.getElementById('searchDropdown').style.display='none';
}

function renderTable(type){
  const key=type==='PEN'?PEN_KEY:DB_KEY;
  const table=document.getElementById(type==='PEN'?'tablePEN':'tableDB');
  const search=document.getElementById(type==='PEN'?'searchPen':'searchDB').value.toLowerCase();
  const fowj=document.getElementById(type==='PEN'?'filterFowjPen':'filterFowjDB').value;
  const sNum=document.getElementById(type==='PEN'?'filterSNumPen':'filterSNumDB').value;
  const sName=document.getElementById(type==='PEN'?'filterSNamePen':'filterSNameDB').value;
  let db=JSON.parse(localStorage.getItem(key)||'[]');
  db=db.filter(r=>{
    return (!search||r.fullName.toLowerCase().includes(search)) &&
           (!fowj||r.fowj===fowj) &&
           (!sNum||r.sariyaNum===sNum) &&
           (!sName||r.sariyaName===sName);
  });
  const names=db.map(r=>r.fullName);
  const dupNames=names.filter((v,i,a)=>a.indexOf(v)!==i);
  document.getElementById(type==='PEN'?'statsPEN':'statsDB').innerText=`ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${type==='PEN'?'Ø§Ù„Ù…Ø¹Ø§Ù‚Ø¨ÙŠÙ†':'Ø§Ù„Ø£ÙØ±Ø§Ø¯'}: ${db.length} | Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª: ${dupNames.length}`;

  table.querySelector('thead').innerHTML='<tr>'+fields.map(f=>`<th>${f}</th>`).join('')+(type==='PEN'?'<th>Ø±ÙØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©</th>':'')+'</tr>';
  table.querySelector('tbody').innerHTML=db.map((r,i)=>{
    let tds=fields.map(f=>`<td${dupNames.includes(r.fullName)?' class="duplicate"':''}>${r[f]||''}</td>`).join('');
    if(type==='PEN') tds+=`<td><button class="btn btn-undo" onclick="undoPen(${i})">Ø±ÙØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©</button></td>`;
    return `<tr>${tds}</tr>`;
  }).join('');
}

function exportCSV(type){
  const key=type==='PEN'?PEN_KEY:DB_KEY;
  const db=JSON.parse(localStorage.getItem(key)||'[]');
  let csv="\uFEFF"+fields.join(",")+"\n"+db.map(r=>fields.map(f=>`"${r[f]||''}"`).join(",")).join("\n");
  let a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=(type==='PEN'?'Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª':'Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©_Ø§Ù„ÙƒØ§Ù…Ù„Ø©')+".csv"; a.click();
}

function importCSV(input,type){
  if(!input.files[0]) return;
  let reader=new FileReader();
  reader.onload=function(e){
    let lines=e.target.result.split("\n");
    let key = type==='PEN'?PEN_KEY:DB_KEY;
    let db = JSON.parse(localStorage.getItem(key)||'[]');
    lines.slice(1).forEach(line=>{
      let cols=line.split(",");
      if(cols.length>=fields.length){
        let obj={};
        fields.forEach((f,i)=>obj[f]=(cols[i]||'').replace(/"/g,'').trim());
        db.push(obj);
      }
    });
    localStorage.setItem(key, JSON.stringify(db));
    alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ "+(type==='PEN'?'Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª':''+'Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©'));
    renderTable(type);
  };
  reader.readAsText(input.files[0]);
}

// Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
function changeTheme(c){document.documentElement.style.setProperty('--main-color',c);localStorage.setItem('306_theme',c);}
function updateBackground(input){if(!input.files[0])return;let reader=new FileReader();reader.onload=e=>{document.body.style.backgroundImage=`url(${e.target.result})`;localStorage.setItem('306_bg',e.target.result)};reader.readAsDataURL(input.files[0]);}

window.onload=()=>{
  let c=localStorage.getItem('306_theme'); if(c) changeTheme(c);
  let bg=localStorage.getItem('306_bg'); if(bg)document.body.style.backgroundImage=`url(${bg})`;
  renderTable('DB'); renderTable('PEN');
};
</
