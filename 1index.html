<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ - Ù„ÙˆØ§Ø¡ 306</title>
    <style>
        :root { --main-color: #1b5e20; --accent-color: #c62828; --form-bg: rgba(255, 255, 255, 0.95); }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; direction: rtl; background-size: cover; background-attachment: fixed; background-position: center; }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--main-color); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center; width: 350px; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; text-align: center; }
        
        .container { max-width: 1350px; margin: 15px auto; background: var(--form-bg); padding: 25px; border-radius: 12px; display: none; }
        .header-title { text-align: center; color: var(--main-color); border-bottom: 4px double var(--main-color); margin-bottom: 25px; padding-bottom: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .field-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; font-size: 13px; color: #333; }
        input { padding: 10px; border: 1px solid #bbb; border-radius: 5px; text-align: center; font-size: 14px; background: white; }
        .button-bar { margin-top: 20px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
        .btn { padding: 10px 18px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; font-size: 14px; }
        .btn-save { background: var(--main-color); flex: 1; font-size: 16px; margin-top: 15px; }
        .btn-update { background: #f57c00; flex: 1; font-size: 16px; margin-top: 15px; }
        .btn-penalty { background: var(--accent-color); }
        
        .search-box { position: relative; margin: 0 auto 20px auto; width: 100%; max-width: 1000px; display: block; }
        #searchDropdown { position: absolute; width: 100%; background: white; border: 2px solid var(--main-color); z-index: 9999; display: none; max-height: 250px; overflow-y: auto; }
        .search-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; text-align: right; }
        
        .view-section { display: none; margin-top: 30px; border-top: 2px solid #ddd; padding-top: 20px; }
        .table-wrapper { overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; background: white; }
        table { width: 100%; border-collapse: collapse; min-width: 3500px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; font-size: 13px; }
        th { background: var(--main-color); color: white; }
        
        .admin-only { display: none; }
        .control-group { background: #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; }

        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; border-right: 5px solid var(--main-color); }
        .stat-card h4 { margin: 0; color: #666; font-size: 14px; }
        .stat-card p { margin: 10px 0 0; font-size: 22px; font-weight: bold; color: var(--main-color); }

        @media print {
            .no-print { display: none !important; }
            #printPage { display: block !important; width: 210mm; padding: 10mm; margin: 0 auto; position: relative; }
            #printPage::before { 
                content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                background-image: var(--bg-img); background-size: 50%; background-repeat: no-repeat; 
                background-position: center; opacity: 0.1; z-index: -1; 
            }
            .print-grid { display: grid !important; grid-template-columns: repeat(3, 1fr) !important; gap: 5px !important; border: 1px solid #000; }
            .print-box { border: 1px solid #000; padding: 5px; display: flex; flex-direction: column; font-size: 11px; }
            .print-box b { border-bottom: 1px solid #000; margin-bottom: 3px; }
        }
        #printPage { display: none; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2 style="color: var(--main-color);">Ù†Ø¸Ø§Ù… Ù„ÙˆØ§Ø¡ 306</h2>
        <input type="text" id="userInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="passInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn" style="background: var(--main-color); width: 100%;" onclick="checkLogin()">Ø¯Ø®ÙˆÙ„</button>
        <p id="loginError" style="color: red; font-size: 12px; display: none; margin-top: 10px;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!</p>
    </div>
</div>

<div class="container no-print" id="appContent">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 class="header-title" style="flex-grow: 1;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ - Ù„ÙˆØ§Ø¡ 306</h1>
        <button class="btn" style="background: #444;" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="search-box">
        <input type="text" id="mainSearch" autocomplete="off" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù…..." oninput="searchNames(this.value)" style="width:100%; padding:14px; border-radius:8px; border:2px solid var(--main-color);">
        <div id="searchDropdown"></div>
    </div>

    <div class="button-bar">
        <button class="btn admin-only" style="background:#0277bd" onclick="toggleSection('mainBase')">ğŸ“‹ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="btn admin-only" style="background:var(--accent-color)" onclick="toggleSection('penaltyBase')">âš–ï¸ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª</button>
        <button class="btn" style="background:#6a1b9a" onclick="updateStats(); toggleSection('statsPanel')">ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        <button class="btn" style="background:#444" onclick="preparePrint()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© A4</button>
        <button class="btn admin-only" style="background:#8d6e63" onclick="toggleSection('historyPanel')">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</button>
        <button class="btn admin-only" style="background:#2e7d32" onclick="exportToCSV('all')">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„</button>
        <button class="btn admin-only" style="background:#607d8b" onclick="downloadTemplate()">ğŸ“„ Ø²Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
        <button class="btn admin-only" style="background:#1565c0" onclick="document.getElementById('fileIn').click()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
        <input type="file" id="fileIn" hidden onchange="importFromCSV(this)">
        <button class="btn admin-only" style="background:#546e7a" onclick="toggleSection('settingsPanel')">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    </div>

    <div id="historyPanel" class="view-section">
        <h3>ğŸ“œ Ø³Ø¬Ù„ Ù†Ø´Ø§Ø·Ø§Øª Ø§Ù„ÙŠÙˆØ²Ø±</h3>
        <div class="table-wrapper"><table style="min-width: 800px;"><thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th></tr></thead><tbody id="historyTb"></tbody></table></div>
        <button class="btn" style="background:red; margin-top:10px;" onclick="clearHistory()">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
    </div>

    <div id="statsPanel" class="view-section">
        <h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ÙˆØ§Ø¡ 306</h3>
        <div id="statsContent" class="stats-container"></div>
    </div>

    <form id="dataForm" class="form-grid" style="margin-top:25px;"></form>

    <div class="admin-only" id="adminActions" style="gap:10px; width: 100%;">
        <button class="btn btn-save" onclick="saveData('main')">ğŸ’¾ Ø¥Ø¶Ø§ÙØ© ÙƒØ¬Ø¯ÙŠØ¯</button>
        <button class="btn btn-update" onclick="updateData()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    </div>
    <button class="btn btn-penalty admin-only" style="width:100%; margin-top:10px;" id="penaltyBtn" onclick="saveData('pen')">âš–ï¸ ØªØ±Ø­ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª</button>

    <div id="settingsPanel" class="view-section">
        <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªØ­ÙƒÙ…</h3>
        <div class="control-group admin-only">
            <h4>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…</h4>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="newU" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <input type="password" id="newP" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn" style="background:var(--main-color)" onclick="addNewUser()">Ø¥Ø¶Ø§ÙØ© ÙŠÙˆØ²Ø±</button>
            </div>
            <div id="usersList"></div>
        </div>
        <div class="control-group">
            <label>Ù„ÙˆÙ† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:</label> <input type="color" id="colorPicker" onchange="updateThemeColor(this.value)" style="width:100%;">
            <label>Ø´ÙØ§ÙÙŠØ© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©:</label> <input type="range" min="10" max="100" value="95" oninput="updateOpacity(this.value)" style="width:100%;">
            <label>ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© (Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø§Ø¦ÙŠØ©):</label> <input type="file" accept="image/*" onchange="updateBgImage(this)">
        </div>
        <div class="control-group admin-only">
            <h4>ØªØºÙŠÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ø¯Ù…Ù†</h4>
            <input type="password" id="oldPass" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„Ø¢Ø¯Ù…Ù†">
            <input type="text" id="newName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¢Ø¯Ù…Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯">
            <input type="password" id="newPass" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¢Ø¯Ù…Ù†">
            <button class="btn btn-update" style="width:100%;" onclick="changeAdminCredentials()">ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢Ø¯Ù…Ù†</button>
        </div>
        <div id="labelSettings" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
        <button class="btn btn-save" style="width:100%; margin-top:10px;" onclick="saveLabels()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ù…ÙŠØ§Øª</button>
    </div>

    <div id="mainBase" class="view-section">
        <h3>ğŸ“‹ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
        <div style="background:#f4f4f4; padding:12px; margin-bottom:10px; border-radius:8px; display:flex; gap:10px; flex-wrap: wrap;">
            <button class="btn" style="background:#333" onclick="toggleAll('m')">ğŸ”˜ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
            <input type="text" id="f1" placeholder="ÙØ±Ø² Ø¨Ø§Ù„ÙÙˆØ¬..." onkeyup="applyFixFilter('tb1')">
            <input type="text" id="f2" placeholder="ÙØ±Ø² Ø¨Ø§Ù„Ø³Ø±ÙŠØ©..." onkeyup="applyFixFilter('tb1')">
            <button class="btn admin-only" style="background:#1b5e20" onclick="exportToCSV('selected')">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
            <button class="btn admin-only" style="background:red" onclick="deleteItems('main')">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
        </div>
        <div class="table-wrapper"><table><thead><tr id="th1"></tr></thead><tbody id="tb1"></tbody></table></div>
    </div>

    <div id="penaltyBase" class="view-section">
        <h3>âš–ï¸ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª</h3>
        <div style="background:#f4f4f4; padding:12px; margin-bottom:10px; border-radius:8px; display:flex; gap:10px;">
            <button class="btn" style="background:#333" onclick="toggleAll('p')">ğŸ”˜ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
            <button class="btn admin-only" style="background:orange" onclick="moveItems('pen', 'main')">ğŸ”“ Ø±ÙØ¹ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©</button>
            <button class="btn admin-only" style="background:red" onclick="deleteItems('pen')">ğŸ—‘ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
        </div>
        <div class="table-wrapper"><table><thead><tr id="th2"></tr></thead><tbody id="tb2"></tbody></table></div>
    </div>
</div>

<div id="printPage"><div class="print-header" style="text-align:center;"><h1>Ù„ÙˆØ§Ø¡ 306</h1><h2>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h2><hr></div><div id="printGrid" class="print-grid"></div></div>

<script>
    const keys = ["id","fullName","birthDate","birthPlace","gender","motherName","natId","marital","wife","kids","edu","spec","job","prov","dist","subDist","area","mahala","zuqaq","dar","landmark","phone","brigade","fowj","sariyaNum","sanaf","exp","refN","refP","notes","sariyaName"];
    let labels = JSON.parse(localStorage.getItem('LWA306_LABELS')) || ["ID","Ø§Ù„Ø§Ø³Ù…","Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯","Ù…Ø­Ù„ Ø§Ù„ØªÙˆÙ„Ø¯","Ø§Ù„Ø¬Ù†Ø³","Ø§Ù„Ø£Ù…","Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©","Ø§Ù„Ø­Ø§Ù„Ø©","Ø§Ù„Ø²ÙˆØ¬Ø©","Ø§Ù„Ø£Ø·ÙØ§Ù„","Ø§Ù„Ø¯Ø±Ø§Ø³Ø©","Ø§Ù„ØªØ®ØµØµ","Ø§Ù„ÙˆØ¸ÙŠÙØ©","Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©","Ø§Ù„Ù‚Ø¶Ø§Ø¡","Ø§Ù„Ù†Ø§Ø­ÙŠØ©","Ø§Ù„Ù…Ù†Ø·Ù‚Ø©","Ø§Ù„Ù…Ø­Ù„Ø©","Ø§Ù„Ø²Ù‚Ø§Ù‚","Ø§Ù„Ø¯Ø§Ø±","Ø¯Ø§Ù„Ø©","Ø§Ù„Ù‡Ø§ØªÙ","Ø§Ù„Ù„ÙˆØ§Ø¡","Ø§Ù„ÙÙˆØ¬","Ø§Ù„Ø³Ø±ÙŠØ©","Ø§Ù„ØµÙ†Ù","Ø§Ù„Ø®Ø¨Ø±Ø©","Ø§Ù„Ù…Ø¹Ø±Ù","Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø¹Ø±Ù","Ù…Ù„Ø§Ø­Ø¸Ø§Øª","Ø§Ø³Ù… Ø§Ù„Ø³Ø±ÙŠØ©"];
    let auth = JSON.parse(localStorage.getItem('LWA306_AUTH')) || { admin: {u:'admin', p:'100'}, users: [{u:'user', p:'200'}] };
    let currentUid = null;
    let currentUser = "";
    let db;

    // --- Ù†Ø¸Ø§Ù… IndexedDB Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
    function openDatabase() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open("LWA306_Database", 2);
            request.onupgradeneeded = e => {
                const dbRes = e.target.result;
                if(!dbRes.objectStoreNames.contains("main")) dbRes.createObjectStore("main", {keyPath: "uid"});
                if(!dbRes.objectStoreNames.contains("pen")) dbRes.createObjectStore("pen", {keyPath: "uid"});
            };
            request.onsuccess = e => { db = e.target.result; resolve(); };
            request.onerror = e => reject();
        });
    }

    async function getAllData(storeName) {
        return new Promise(resolve => {
            const tx = db.transaction(storeName, "readonly");
            const store = tx.objectStore(storeName);
            const request = store.getAll();
            request.onsuccess = () => resolve(request.result);
        });
    }

    async function saveToDB(storeName, item) {
        const tx = db.transaction(storeName, "readwrite");
        tx.objectStore(storeName).put(item);
        return new Promise(resolve => tx.oncomplete = resolve);
    }

    async function deleteFromDB(storeName, uid) {
        const tx = db.transaction(storeName, "readwrite");
        tx.objectStore(storeName).delete(uid);
        return new Promise(resolve => tx.oncomplete = resolve);
    }

    // --- Ø¨Ù‚ÙŠØ© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ DB ---

    async function checkLogin() {
        await openDatabase();
        const u = document.getElementById('userInput').value; const p = document.getElementById('passInput').value;
        if(u === auth.admin.u && p === auth.admin.p) { currentUser = "admin"; setupRole('admin'); }
        else {
            const foundUser = auth.users.find(x => x.u === u && x.p === p);
            if(foundUser) { currentUser = u; setupRole('user'); }
            else document.getElementById('loginError').style.display = 'block';
        }
    }

    async function setupRole(role) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        initUI();
        renderUsersList();
        renderHistory();
        await renderTables();
        if(role === 'admin') {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
        } else {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
            document.querySelectorAll('input:not(#mainSearch):not(#userInput):not(#passInput):not(#f1):not(#f2)').forEach(i => i.readOnly = true);
        }
    }

    function logAction(type, detail) {
        if(currentUser === "admin") return;
        let history = JSON.parse(localStorage.getItem('306_history') || '[]');
        history.push({ time: new Date().toLocaleString(), user: currentUser, type: type, detail: detail });
        localStorage.setItem('306_history', JSON.stringify(history.slice(-500))); // Ø­ÙØ¸ Ø¢Ø®Ø± 500 Ø­Ø±ÙƒØ© ÙÙ‚Ø·
    }

    function renderHistory() {
        const history = JSON.parse(localStorage.getItem('306_history') || '[]');
        document.getElementById('historyTb').innerHTML = history.reverse().map(h => `<tr><td>${h.time}</td><td>${h.user}</td><td>${h.type}</td><td>${h.detail}</td></tr>`).join('');
    }

    function clearHistory() { if(confirm("Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ØŸ")) { localStorage.removeItem('306_history'); renderHistory(); } }

    function addNewUser() {
        const u = document.getElementById('newU').value; const p = document.getElementById('newP').value;
        if(u && p) {
            auth.users.push({u, p});
            localStorage.setItem('LWA306_AUTH', JSON.stringify(auth));
            renderUsersList();
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
        }
    }

    function deleteUser(idx) {
        if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) {
            auth.users.splice(idx, 1);
            localStorage.setItem('LWA306_AUTH', JSON.stringify(auth));
            renderUsersList();
        }
    }

    function renderUsersList() {
        const list = document.getElementById('usersList');
        if(!list) return;
        list.innerHTML = auth.users.map((u, i) => `<div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #ccc; margin-top:5px; background:white; border-radius:4px;"><span>ğŸ‘¤ ${u.u}</span><button onclick="deleteUser(${i})" style="color:red; border:none; background:none; cursor:pointer;">Ø­Ø°Ù</button></div>`).join('');
    }

    function changeAdminCredentials() {
        const old = document.getElementById('oldPass').value;
        if(old !== auth.admin.p) return alert("Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„Ø¢Ø¯Ù…Ù† Ø®Ø·Ø£");
        auth.admin.u = document.getElementById('newName').value || auth.admin.u;
        auth.admin.p = document.getElementById('newPass').value || auth.admin.p;
        localStorage.setItem('LWA306_AUTH', JSON.stringify(auth));
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¢Ø¯Ù…Ù†");
    }

    function initUI() {
        const form = document.getElementById('dataForm'); const settings = document.getElementById('labelSettings');
        form.innerHTML = ""; settings.innerHTML = "";
        keys.forEach((k, i) => {
            form.innerHTML += `<div class="field-group"><label>${labels[i]}</label><input type="text" id="${k}"></div>`;
            settings.innerHTML += `<div class="field-group"><label>${k}</label><input type="text" id="set_${i}" value="${labels[i]}"></div>`;
        });
        loadStyles();
    }

    function loadStyles() {
        const c = localStorage.getItem('306_col'); if(c) updateThemeColor(c);
        const o = localStorage.getItem('306_op'); if(o) updateOpacity(o);
        const b = localStorage.getItem('306_bg'); if(b) { document.body.style.backgroundImage = `url(${b})`; document.documentElement.style.setProperty('--bg-img', `url(${b})`); }
    }

    function updateThemeColor(v) { document.documentElement.style.setProperty('--main-color', v); localStorage.setItem('306_col', v); }
    function updateOpacity(v) { document.documentElement.style.setProperty('--form-bg', `rgba(255, 255, 255, ${v/100})`); localStorage.setItem('306_op', v); }
    function updateBgImage(i) { if(i.files[0]) { const r = new FileReader(); r.onload = e => { document.body.style.backgroundImage = `url(${e.target.result})`; document.documentElement.style.setProperty('--bg-img', `url(${e.target.result})`); localStorage.setItem('306_bg', e.target.result); }; r.readAsDataURL(i.files[0]); } }

    async function renderTables() {
        const m = await getAllData('main'); const p = await getAllData('pen');
        const h = "<th>ØªØ­Ø¯ÙŠØ¯</th>" + labels.map(l => `<th>${l}</th>`).join('');
        document.getElementById('th1').innerHTML = h; document.getElementById('th2').innerHTML = h;
        const row = (r, t) => `<tr data-uid="${r.uid}"><td><input type="checkbox" class="c-${t}" value="${r.uid}"></td>${keys.map(k => `<td>${r[k]||''}</td>`).join('')}</tr>`;
        document.getElementById('tb1').innerHTML = m.map(r => row(r, 'm')).join('');
        document.getElementById('tb2').innerHTML = p.map(r => row(r, 'p')).join('');
    }

    function applyFixFilter(tableId) {
        const f1 = document.getElementById('f1').value.trim().toUpperCase();
        const f2 = document.getElementById('f2').value.trim().toUpperCase();
        const rows = document.getElementById(tableId).getElementsByTagName('tr');
        const idxFowj = keys.indexOf("fowj") + 1;
        const idxSariya = keys.indexOf("sariyaNum") + 1;
        for (let r of rows) {
            const v1 = r.cells[idxFowj] ? r.cells[idxFowj].textContent.toUpperCase() : "";
            const v2 = r.cells[idxSariya] ? r.cells[idxSariya].textContent.toUpperCase() : "";
            r.style.display = (v1.includes(f1) && v2.includes(f2)) ? "" : "none";
        }
    }

    async function updateStats() {
        const m = await getAllData('main'); const p = await getAllData('pen');
        const fowjData = {};
        m.forEach(i => { if(i.fowj) fowjData[i.fowj] = (fowjData[i.fowj] || 0) + 1; });
        let html = `<div class="stat-card"><h4>Ø§Ù„Ù‚ÙˆØ© Ø§Ù„ÙƒÙ„ÙŠØ© (Ø§Ù„Ù„ÙˆØ§Ø¡)</h4><p>${m.length}</p></div>`;
        html += `<div class="stat-card" style="border-right-color:var(--accent-color)"><h4>Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª</h4><p>${p.length}</p></div>`;
        for (let f in fowjData) { html += `<div class="stat-card" style="border-right-color:#0277bd"><h4>${f}</h4><p>${fowjData[f]}</p></div>`; }
        document.getElementById('statsContent').innerHTML = html;
    }

    async function deleteItems(type) {
        if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ØŸ")) return;
        const selectedUids = Array.from(document.querySelectorAll(`.c-${type==='main'?'m':'p'}:checked`)).map(c => c.value);
        for(let uid of selectedUids) { await deleteFromDB(type, uid); }
        await renderTables();
    }

    async function moveItems(f, t) {
        const selectedUids = Array.from(document.querySelectorAll('.c-p:checked')).map(c => c.value);
        const dbF = await getAllData(f);
        for(let id of selectedUids) {
            let item = dbF.find(x => String(x.uid) === String(id));
            if(item) {
                await saveToDB(t, item);
                await deleteFromDB(f, item.uid);
            }
        }
        await renderTables();
    }

    async function exportToCSV(mode) {
        let dbData = await getAllData('main');
        if(mode === 'selected') {
            const ids = Array.from(document.querySelectorAll('.c-m:checked')).map(c => c.value);
            if(ids.length === 0) return alert("Ø­Ø¯Ø¯ Ø£Ø³Ù…Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹");
            dbData = dbData.filter(item => ids.includes(String(item.uid)));
        }
        const csv = "\uFEFF" + labels.join(",") + "\n" + dbData.map(r => keys.map(k => `"${r[k]||''}"`).join(",")).join("\n");
        const l = document.createElement("a"); l.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); l.download = "data_306.csv"; l.click();
    }

    async function saveData(type) {
        let d = { uid: "UID_" + Date.now() + "_" + Math.floor(Math.random()*1000) };
        keys.forEach(k => d[k] = document.getElementById(k).value);
        if(!d.fullName) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨");
        await saveToDB(type, d);
        await renderTables();
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
    }

    async function updateData() {
        if(!currentUid) return alert("Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù…");
        const dbM = await getAllData('main');
        let item = dbM.find(x => String(x.uid) === String(currentUid));
        if(item) { 
            keys.forEach(k => item[k] = document.getElementById(k).value); 
            await saveToDB('main', item);
            await renderTables();
            alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"); 
        }
    }

    async function searchNames(v) {
        if(v.length < 2) { document.getElementById('searchDropdown').style.display = 'none'; return; }
        const dbM = await getAllData('main');
        const matches = dbM.filter(i => i.fullName && i.fullName.includes(v));
        const drop = document.getElementById('searchDropdown');
        drop.innerHTML = matches.map(m => `<div class="search-item" onclick="loadItem('${m.uid}')">${m.fullName}</div>`).join('');
        drop.style.display = 'block';
        if(v.length > 3) logAction("Ø¨Ø­Ø«", v);
    }

    async function loadItem(uid) {
        const dbM = await getAllData('main');
        const item = dbM.find(i => String(i.uid) === String(uid));
        if(item) { keys.forEach(k => document.getElementById(k).value = item[k] || ''); currentUid = uid; }
        document.getElementById('searchDropdown').style.display = 'none';
    }

    async function importFromCSV(inp) {
        const r = new FileReader(); r.onload = async e => {
            const lines = e.target.result.split(/\r?\n/);
            for(let i=1; i<lines.length; i++) {
                const cols = lines[i].split(",");
                if(cols.length > 5) {
                    let o = { uid: "IMP_" + Date.now() + "_" + i };
                    keys.forEach((k, idx) => o[k] = cols[idx] ? cols[idx].replace(/"/g,'').trim() : "");
                    await saveToDB('main', o);
                }
            }
            await renderTables(); alert("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯");
        }; r.readAsText(inp.files[0], 'UTF-8');
    }

    function saveLabels() {
        const nl = []; keys.forEach((_, i) => nl.push(document.getElementById(`set_${i}`).value));
        localStorage.setItem('LWA306_LABELS', JSON.stringify(nl)); location.reload();
    }

    function toggleSection(id) { const s = document.getElementById(id); s.style.display = (s.style.display === 'block') ? 'none' : 'block'; }
    function toggleAll(t) { 
        const tableId = (t === 'm') ? 'tb1' : 'tb2';
        const visibleChecks = Array.from(document.querySelectorAll(`#${tableId} tr`)).filter(tr => tr.style.display !== 'none').map(tr => tr.querySelector('input[type="checkbox"]'));
        const allChecked = visibleChecks.every(c => c.checked);
        visibleChecks.forEach(c => c.checked = !allChecked);
    }
    function downloadTemplate() { const csv = "\uFEFF" + labels.join(",") + "\n"; const l = document.createElement("a"); l.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); l.download = "Template.csv"; l.click(); }
    
    function preparePrint() { 
        let h = ""; 
        keys.forEach((k, i) => { h += `<div class="print-box"><b>${labels[i]}</b><span>${document.getElementById(k).value || '...'}</span></div>`; }); 
        document.getElementById('printGrid').innerHTML = h;
        logAction("Ø·Ø¨Ø§Ø¹Ø©", document.getElementById('fullName').value);
        window.print(); 
    }
</script>
</body>
</html>
